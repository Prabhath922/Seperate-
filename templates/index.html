<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Waste Classifier</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 600px;
        text-align: center;
      }

      form {
        margin-top: 2rem;
        border: 1px solid #ddd;
        padding: 1.5rem;
        border-radius: 8px;
      }

      input[type="file"] {
        width: 100%;
        margin-bottom: 1rem;
      }

      button {
        background-color: #2563eb;
        color: white;
        border: none;
        padding: 0.6rem 1.4rem;
        border-radius: 6px;
        cursor: pointer;
        margin: 0.3rem;
      }

      #cameraSection {
        margin: 2rem 0;
      }

      #video {
        width: 100%;
        max-width: 480px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      #canvas {
        display: none;
      }

      .result {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 8px;
        background-color: #f8f9fa;
      }

      .camera-buttons {
        margin: 1rem 0;
      }

      .switch-mode {
        margin-top: 1rem;
      }

      #toggleCamera {
        background-color: #6b7280;
      }

      #captureBtn {
        background-color: #059669;
      }

      #stopCamera {
        background-color: #dc2626;
      }
    </style>
  </head>
  <body>
    <h1>Waste Image Classifier</h1>
    <p>Select an image or use your camera to classify cardboard, glass, metal, paper, plastic, or trash.</p>

    <!-- Camera Section -->
    <div id="cameraSection" style="display: none;">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      <div id="liveResult" class="result" style="display: none;">
        <p><strong>Live Prediction:</strong> <span id="liveLabel">--</span></p>
        <p><strong>Confidence:</strong> <span id="liveConfidence">--</span></p>
      </div>
      <div id="liveError" class="result" style="display: none;"></div>
      <div class="camera-buttons">
        <button id="captureBtn">Capture & Classify</button>
        <button id="stopCamera">Stop Camera</button>
      </div>
    </div>

    <!-- File Upload Section -->
    <form method="post" enctype="multipart/form-data" id="uploadForm">
      <input type="file" name="image" accept="image/*" required />
      <button type="submit">Classify Uploaded Image</button>
    </form>

    <!-- Switch between modes -->
    <div class="switch-mode">
      <button id="toggleCamera">Use Camera Instead</button>
    </div>

    <div id="uploadResult">
      {% if prediction %}
      <div class="result">
        {% if confidence %}
        <p><strong>Prediction:</strong> {{ prediction }}</p>
        <p><strong>Confidence:</strong> {{ "%.1f"|format(confidence * 100) }}%</p>
        {% else %}
        <p>{{ prediction }}</p>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <script>
      // DOM Elements
      const cameraSection = document.getElementById('cameraSection');
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const captureBtn = document.getElementById('captureBtn');
      const stopCamera = document.getElementById('stopCamera');
      const toggleCamera = document.getElementById('toggleCamera');
      const uploadForm = document.getElementById('uploadForm');
      const liveResult = document.getElementById('liveResult');
      const liveLabel = document.getElementById('liveLabel');
      const liveConfidence = document.getElementById('liveConfidence');
      const liveError = document.getElementById('liveError');
      const uploadResult = document.getElementById('uploadResult');

      let stream = null;
      let classificationTimer = null;
      let isClassifying = false;

      // Toggle between camera and file upload
      toggleCamera.addEventListener('click', function() {
        if (cameraSection.style.display === 'none') {
          cameraSection.style.display = 'block';
          uploadForm.style.display = 'none';
          toggleCamera.textContent = 'Use File Upload Instead';
          startCamera();
        } else {
          cameraSection.style.display = 'none';
          uploadForm.style.display = 'block';
          toggleCamera.textContent = 'Use Camera Instead';
          stopCameraStream();
        }
      });

      function updateLiveResult(prediction, confidence) {
        if (!prediction) {
          liveResult.style.display = 'none';
          return;
        }
        liveError.style.display = 'none';
        liveResult.style.display = 'block';
        liveLabel.textContent = prediction;
        liveConfidence.textContent =
          typeof confidence === 'number'
            ? `${(confidence * 100).toFixed(1)}%`
            : '--';
      }

      function showLiveError(message) {
        liveResult.style.display = 'none';
        liveError.style.display = 'block';
        liveError.textContent = message;
      }

      function clearLiveDisplays() {
        liveResult.style.display = 'none';
        liveError.style.display = 'none';
        liveLabel.textContent = '--';
        liveConfidence.textContent = '--';
      }

      function updateUploadResult(prediction, confidence, errorMessage) {
        if (!uploadResult) return;

        if (errorMessage) {
          uploadResult.innerHTML = `<div class="result"><p>${errorMessage}</p></div>`;
          return;
        }

        if (!prediction) {
          uploadResult.innerHTML = '';
          return;
        }

        const confidenceHtml =
          typeof confidence === 'number'
            ? `<p><strong>Confidence:</strong> ${(confidence * 100).toFixed(1)}%</p>`
            : '';

        uploadResult.innerHTML = `
          <div class="result">
            <p><strong>Prediction:</strong> ${prediction}</p>
            ${confidenceHtml}
          </div>
        `;
      }

      // Start camera
      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          video.srcObject = stream;
          startLiveClassification();
        } catch (err) {
          console.error('Error accessing camera:', err);
          alert('Unable to access camera. Please check permissions and try again.');
          cameraSection.style.display = 'none';
          uploadForm.style.display = 'block';
          toggleCamera.textContent = 'Use Camera Instead';
          stopLiveClassification();
        }
      }

      function startLiveClassification() {
        if (classificationTimer) return;
        classificationTimer = setInterval(() => {
          classifyFrame(false);
        }, 1500);
      }

      function stopLiveClassification() {
        if (classificationTimer) {
          clearInterval(classificationTimer);
          classificationTimer = null;
        }
        isClassifying = false;
        clearLiveDisplays();
      }

      // Stop camera
      function stopCameraStream() {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
        stopLiveClassification();
      }

      function classifyFrame(updateUploadCard) {
        if (!stream || isClassifying) return;
        if (video.videoWidth === 0 || video.videoHeight === 0) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        isClassifying = true;
        canvas.toBlob(
          function(blob) {
            if (!blob) {
              isClassifying = false;
              return;
            }

            const formData = new FormData();
            formData.append('image', blob, 'frame.jpg');

            fetch('/classify', {
              method: 'POST',
              body: formData
            })
              .then(response => response.json())
              .then(data => {
                if (data.error) {
                  showLiveError(data.error);
                  if (updateUploadCard) {
                    updateUploadResult(null, null, data.error);
                  }
                } else {
                  updateLiveResult(data.prediction, data.confidence);
                  if (updateUploadCard) {
                    updateUploadResult(data.prediction, data.confidence);
                  }
                }
              })
              .catch(error => {
                const message = error.message || 'Error classifying frame.';
                showLiveError(message);
                if (updateUploadCard) {
                  updateUploadResult(null, null, message);
                }
              })
              .finally(() => {
                isClassifying = false;
              });
          },
          'image/jpeg',
          0.8
        );
      }

      // Capture image and submit for classification
      captureBtn.addEventListener('click', function() {
        if (!stream) return;
        classifyFrame(true);
      });

      // Stop camera button
      stopCamera.addEventListener('click', function() {
        stopCameraStream();
        cameraSection.style.display = 'none';
        uploadForm.style.display = 'block';
        toggleCamera.textContent = 'Use Camera Instead';
      });

      // Clean up when leaving page
      window.addEventListener('beforeunload', function() {
        stopCameraStream();
      });
    </script>
  </body>
</html>